metadata:
  id: "CKV2_AWS_69"
  name: "Ensure AWS RDS database instance configured with encryption in transit"
  category: "NETWORKING"
definition:
  and:
    - cond_type: filter
      attribute: resource_type
      value:
        - "aws_db_instance"
      operator: within
    - or:
      - cond_type: "connection"
        resource_types:
          - "aws_db_instance"
        connected_resource_types:
          - "aws_db_parameter_group"
        operator: "not_exists"
      - and:
        - cond_type: "connection"
          resource_types:
            - "aws_db_instance"
          connected_resource_types:
            - "aws_db_parameter_group"
          operator: "exists"
        - or:
          - cond_type: "attribute"
            resource_types:
              - "aws_db_parameter_group"
            attribute: "family"
            operator: "not_regex_match"
            value: "(^postgres|.*sqlserver).*"
          - and:
            - cond_type: "attribute"
              resource_types:
                - "aws_db_parameter_group"
              attribute: "parameter[?(@.name=='rds.force_ssl')].value"
              operator: "jsonpath_exists"
            - cond_type: "attribute"
              resource_types:
                - "aws_db_parameter_group"
              attribute: "parameter[?(@.name=='rds.force_ssl')].value"
              operator: "jsonpath_equals"
              value: "1"
        - or:
          - cond_type: "attribute"
            resource_types:
              - "aws_db_parameter_group"
            attribute: "family"
            operator: "not_regex_match"
            value: "^(mariadb|mysql).*"
          - and:
            - cond_type: "attribute"
              resource_types:
                - "aws_db_parameter_group"
              attribute: "parameter[?(@.name=='require_secure_transport')].value"
              operator: "jsonpath_exists"
            - cond_type: "attribute"
              resource_types:
                - "aws_db_parameter_group"
              attribute: "parameter[?(@.name=='require_secure_transport')].value"
              operator: "jsonpath_equals"
              value: "1"
        - or:
          - cond_type: "attribute"
            resource_types:
              - "aws_db_parameter_group"
            attribute: "family"
            operator: "not_regex_match"
            value: ".*db2-ae.*"
          - and:
            - cond_type: "attribute"
              resource_types:
                - "aws_db_parameter_group"
              attribute: "parameter[?(@.name=='db2comm')].value"
              operator: "jsonpath_exists"
            - cond_type: "attribute"
              resource_types:
                - "aws_db_parameter_group"
              attribute: "parameter[?(@.name=='db2comm')].value"
              operator: "jsonpath_equals"
              value: "SSL"
