metadata:
  name: "Ensure all data stored in the S3 bucket is securely encrypted at rest"
  category: "ENCRYPTION"
  id: "CKV_AWS_19"
definition:
  or:
    - cond_type: attribute
      resource_types:
        - aws_s3_bucket
      attribute: server_side_encryption_configuration.rule.apply_server_side_encryption_by_default.sse_algorithm
      operator: within
      value:
        - "aws:kms"
        - "AES256"
    - and:
      - cond_type: filter
        attribute: resource_type
        operator: within
        value:
          - aws_s3_bucket
      - cond_type: connection
        resource_types:
          - aws_s3_bucket
        connected_resource_types:
          - aws_s3_bucket_server_side_encryption_configuration
        operator: not_exists
      - cond_type: attribute
        resource_types:
          - aws_s3_bucket
        attribute: server_side_encryption_configuration.rule.apply_server_side_encryption_by_default.sse_algorithm
        operator: not_exists # The default for aws_s3_bucket was changed to be encrypted with SSE-S3 which uses AES256
    - and:
      - cond_type: filter
        attribute: resource_type
        operator: within
        value:
          - aws_s3_bucket
      - cond_type: connection
        resource_types:
          - aws_s3_bucket
        connected_resource_types:
          - aws_s3_bucket_server_side_encryption_configuration
        operator: exists
      - cond_type: attribute
        resource_types:
          - aws_s3_bucket_server_side_encryption_configuration
        attribute: rule.apply_server_side_encryption_by_default.sse_algorithm
        operator: within
        value:
          - "aws:kms"
          - "AES256"
