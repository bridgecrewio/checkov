import os
from pathlib import Path
from typing import Dict, Any
from datetime import datetime, timedelta

from checkov.common.bridgecrew.platform_integration import bc_integration, BcPlatformIntegration
from checkov.common.bridgecrew.vulnerability_scanning.integrations.twistcli import TwistcliIntegration
from checkov.common.util.str_utils import removeprefix


class DockerImageScanningIntegration(TwistcliIntegration):
    def report_results(
        self,
        docker_image_name: str,
        dockerfile_path: Path,
        dockerfile_content: str,
        twistcli_scan_result: Dict[str, Any],
    ) -> None:
        super().report_results(
            docker_image_name=docker_image_name,
            dockerfile_path=dockerfile_path,
            dockerfile_content=dockerfile_content,
            twistcli_scan_result=twistcli_scan_result,
        )

    def _create_report(
        self,
        docker_image_name: str,
        dockerfile_path: Path,
        dockerfile_content: str,
        twistcli_scan_result: Dict[str, Any],
    ) -> Dict[str, Any]:
        vulnerabilities = [
            {
                "cveId": vul.get("id"),
                "status": vul.get("status", "open"),
                "severity": vul.get("severity"),
                "packageName": vul.get("packageName"),
                "packageVersion": vul.get("packageVersion"),
                "link": vul.get("link"),
                "cvss": vul.get("cvss"),
                "vector": vul.get("vector"),
                "description": vul.get("description"),
                "riskFactors": vul.get("riskFactors"),
                "publishedDate": vul.get("publishedDate")
                or (datetime.now() - timedelta(days=vul.get("publishedDays", 0))).isoformat(),
            }
            for vul in twistcli_scan_result.get("vulnerabilities") or []
        ]
        payload = {
            "dockerImageName": docker_image_name,
            # BC_ROOT_DIR is used in the platform
            "dockerFilePath": removeprefix(str(dockerfile_path), os.getenv("BC_ROOT_DIR", "")),
            "dockerFileContent": dockerfile_content,
            "type": "Image",
            "sourceId": bc_integration.repo_id,
            "branch": bc_integration.repo_branch,
            "sourceType": bc_integration.bc_source.name,
            "vulnerabilities": vulnerabilities,
        }
        return payload

    # not used for image scanning
    def _create_report_async(
        self,
        twistcli_scan_result: Dict[str, Any],
        bc_platform_integration: BcPlatformIntegration,
        file_path: Path,
        **kwargs: Any,
    ) -> Dict[str, Any]:
        pass


docker_image_scanning_integration = DockerImageScanningIntegration()
