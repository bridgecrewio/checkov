metadata: 
  id: "CKV2_AZURE_52"
  name: "Ensure Synapse SQL Pool has vulnerability assessment attached"
  category: "GENERAL_SECURITY"

definition:
  and:
    - resource_types:
        - Microsoft.Synapse/workspaces/sqlPools
      connected_resource_types:
        - Microsoft.Sql/servers/securityAlertPolicies
      operator: exists
      cond_type: connection
    - resource_types:
        - Microsoft.Sql/servers/securityAlertPolicies
      connected_resource_types:
        - Microsoft.Sql/servers/vulnerabilityAssessments
      operator: exists
      cond_type: connection
    - cond_type: filter
      attribute: resource_type
      value:
        - Microsoft.Synapse/workspaces/sqlPools
      operator: within
    - or:
      - and:
        - cond_type: attribute
          resource_types:
            - Microsoft.Sql/servers/vulnerabilityAssessments
          attribute: properties.recurringScans.isEnabled
          operator: exists

        - cond_type: attribute
          resource_types:
            - Microsoft.Sql/servers/vulnerabilityAssessments
          attribute: properties.recurringScans.isEnabled
          operator: equals
          value: true

      - cond_type: attribute
        resource_types:
          - Microsoft.Sql/servers/vulnerabilityAssessments
        attribute: properties.recurringScans.isEnabled
        operator: not_exists